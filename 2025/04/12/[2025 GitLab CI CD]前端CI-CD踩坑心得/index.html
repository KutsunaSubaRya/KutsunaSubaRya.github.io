<!DOCTYPE html><html lang="zh-TW"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0"><meta name="theme-color" content="#0078E7"><meta name="author" content="SubaRya"><meta name="copyright" content="SubaRya"><meta name="generator" content="Hexo 5.4.2"><meta name="theme" content="hexo-theme-yun"><title>å‰ç«¯ CI-CD è¸©å‘èˆ‡ Cloudflare Zero Trust Access ä½¿ç”¨å¿ƒå¾— | ã‚¹ãƒãƒªãƒ£ãƒãƒ–ãƒ­ã‚°</title><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Noto+Serif+SC:wght@900&amp;display=swap" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/star-markdown-css@0.1.24/dist/yun/yun-markdown.min.css"><script src="//at.alicdn.com/t/font_1140697_j5gk85dg4pf.js" async></script><script src="https://cdn.jsdelivr.net/npm/scrollreveal/dist/scrollreveal.min.js" defer></script><script>document.addEventListener("DOMContentLoaded", () => {
  [".post-card",".post-content img"].forEach((target)=> {
    ScrollReveal().reveal(target);
  })
});
</script><link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/katex@latest/dist/katex.min.css"><script defer src="https://cdn.jsdelivr.net/npm/katex@latest/dist/katex.min.js"></script><link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/katex@latest/dist/contrib/copy-tex.min.css"><script defer src="https://cdn.jsdelivr.net/npm/katex@latest/dist/contrib/copy-tex.min.js"></script><script defer src="https://cdn.jsdelivr.net/npm/katex@latest/dist/contrib/auto-render.min.js"></script><script>document.addEventListener("DOMContentLoaded", function() {
  renderMathInElement(document.body, {
    delimiters: [
      {left: "$$", right: "$$", display: true},
      {left: "$", right: "$", display: false},
      {left: "\\(", right: "\\)", display: false},
      {left: "\\[", right: "\\]", display: true}
    ]
  });
});</script><link id="light-prism-css" rel="stylesheet" href="https://cdn.jsdelivr.net/npm/prismjs@latest/themes/prism.css" media="(prefers-color-scheme: light)"><link id="dark-prism-css" rel="stylesheet" href="https://cdn.jsdelivr.net/npm/prismjs@latest/themes/prism-tomorrow.css" media="(prefers-color-scheme: dark)"><link rel="shortcut icon" type="image/svg+xml" href="/img/favicon.png"><link rel="mask-icon" href="/img/favicon.png" color="#0078E7"><link rel="alternate icon" href="/yun.ico"><link rel="preload" href="/css/hexo-theme-yun.css" as="style"><link rel="preload" href="/js/utils.js" as="script"><link rel="preload" href="/js/hexo-theme-yun.js" as="script"><link rel="prefetch" href="/js/sidebar.js" as="script"><link rel="preconnect" href="https://cdn.jsdelivr.net" crossorigin><script id="yun-config">
    const Yun = window.Yun || {};
    window.CONFIG = {"hostname":"blog.subarya.me","root":"/","title":"ã‚¹ãƒãƒªãƒ£","version":"1.5.3","mode":"time","copycode":true,"page":{"isPost":true},"i18n":{"placeholder":"æœå°‹...","empty":"æ‰¾ä¸åˆ°æ‚¨æ‰€è¦æŸ¥è©¢çš„å…§å®¹: ${query}","hits":"æ‰¾åˆ° ${hits} ç­†çµæœ","hits_time":"æ‰¾åˆ° ${hits} ç­†çµæœï¼ˆç”¨æ—¶ ${time} æ¯«ç§’ï¼‰"},"anonymous_image":"https://cdn.jsdelivr.net/gh/YunYouJun/cdn/img/avatar/none.jpg","say":{"api":"https://v1.hitokoto.cn","hitokoto":true},"fireworks":{"colors":["255, 255, 0","255, 255, 224","255, 255, 153"]}};
  </script><link rel="stylesheet" href="/css/hexo-theme-yun.css"><script src="/js/utils.js"></script><script src="/js/hexo-theme-yun.js"></script><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/ionicons/dist/css/ionicons.min.css"><link rel="preconnect" href="https://www.google-analytics.com" crossorigin><script async src="https://www.googletagmanager.com/gtag/js?id=G-MVRLRVZSZY"></script><script>if (CONFIG.hostname === location.hostname) {
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());
  gtag('config', 'G-MVRLRVZSZY');
}</script><meta name="description" content="å‰è¨€ï¼š  é€™ç¯‡æ˜¯å°ˆé–€å°æ–¼ GitLab CI&#x2F;CD è€Œå¯«çš„ Writeupï¼Œå¦‚æœæ˜¯ GitHub çš„ï¼Œåƒ…ä¾›åƒè€ƒæ ¸å¿ƒé‚è¼¯å³å¯ã€‚ç­†è€…ç¬¬ä¸€æ¬¡å¯« CI&#x2F;CDï¼Œå¦‚æœ‰èª¤æˆ–æ”¹é€²ä¹‹è™•ï¼Œå¯ä»¥è·Ÿæˆ‘èªª &gt;&lt;   ç›®å‰å°ˆæ¡ˆèˆ‡ remote server çš„æƒ…å¢ƒ å°ˆæ¡ˆ Nuxt3   Server Ubuntu 23.04 x86_64 ä¸»æ©Ÿæ²’æœ‰ç›´æ¥å°å¤–çš„å…¬ç¶² IPï¼Œæ˜¯é€é Cloudfla">
<meta property="og:type" content="article">
<meta property="og:title" content="å‰ç«¯ CI-CD è¸©å‘èˆ‡ Cloudflare Zero Trust Access ä½¿ç”¨å¿ƒå¾—">
<meta property="og:url" content="https://blog.subarya.me/2025/04/12/[2025%20GitLab%20CI%20CD]%E5%89%8D%E7%AB%AFCI-CD%E8%B8%A9%E5%9D%91%E5%BF%83%E5%BE%97/index.html">
<meta property="og:site_name" content="ã‚¹ãƒãƒªãƒ£ãƒãƒ–ãƒ­ã‚°">
<meta property="og:description" content="å‰è¨€ï¼š  é€™ç¯‡æ˜¯å°ˆé–€å°æ–¼ GitLab CI&#x2F;CD è€Œå¯«çš„ Writeupï¼Œå¦‚æœæ˜¯ GitHub çš„ï¼Œåƒ…ä¾›åƒè€ƒæ ¸å¿ƒé‚è¼¯å³å¯ã€‚ç­†è€…ç¬¬ä¸€æ¬¡å¯« CI&#x2F;CDï¼Œå¦‚æœ‰èª¤æˆ–æ”¹é€²ä¹‹è™•ï¼Œå¯ä»¥è·Ÿæˆ‘èªª &gt;&lt;   ç›®å‰å°ˆæ¡ˆèˆ‡ remote server çš„æƒ…å¢ƒ å°ˆæ¡ˆ Nuxt3   Server Ubuntu 23.04 x86_64 ä¸»æ©Ÿæ²’æœ‰ç›´æ¥å°å¤–çš„å…¬ç¶² IPï¼Œæ˜¯é€é Cloudfla">
<meta property="og:locale" content="zh_TW">
<meta property="og:image" content="https://blog.subarya.me/img/gitlabcicd-1.png">
<meta property="og:image" content="https://blog.subarya.me/img/gitlabcicd-4.png">
<meta property="og:image" content="https://blog.subarya.me/img/gitlabcicd-5.png">
<meta property="og:image" content="https://blog.subarya.me/img/gitlabcicd-6.png">
<meta property="og:image" content="https://blog.subarya.me/img/gitlabcicd-7.png">
<meta property="og:image" content="https://blog.subarya.me/img/gitlabcicd-8.png">
<meta property="og:image" content="https://blog.subarya.me/img/gitlabcicd-9.png">
<meta property="og:image" content="https://blog.subarya.me/img/gitlabcicd-10.png">
<meta property="og:image" content="https://blog.subarya.me/img/gitlabcicd-11.png">
<meta property="og:image" content="https://blog.subarya.me/img/gitlabcicd-2.png">
<meta property="og:image" content="https://blog.subarya.me/img/gitlabcicd-3.png">
<meta property="og:image" content="https://blog.subarya.me/img/gitlabcicd-12.png">
<meta property="og:image" content="https://blog.subarya.me/img/gitlabcicd-13.png">
<meta property="og:image" content="https://blog.subarya.me/img/gitlabcicd-14.png">
<meta property="article:published_time" content="2025-04-12T20:00:00.000Z">
<meta property="article:modified_time" content="2025-04-12T20:00:00.000Z">
<meta property="article:author" content="SubaRya">
<meta property="article:tag" content="2025">
<meta property="article:tag" content="remote_server">
<meta property="article:tag" content="CI&#x2F;CD">
<meta property="article:tag" content="GitLab">
<meta property="article:tag" content="DevOps">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://blog.subarya.me/img/gitlabcicd-1.png"><script src="/js/ui/mode.js"></script></head><body><script defer src="https://cdn.jsdelivr.net/npm/animejs@latest"></script><script defer src="/js/ui/fireworks.js"></script><canvas class="fireworks"></canvas><div class="container"><a class="sidebar-toggle hty-icon-button" id="menu-btn"><div class="hamburger hamburger--spin" type="button"><span class="hamburger-box"><span class="hamburger-inner"></span></span></div></a><div class="sidebar-toggle sidebar-overlay"></div><aside class="sidebar"><script src="/js/sidebar.js"></script><ul class="sidebar-nav"><li class="sidebar-nav-item sidebar-nav-toc hty-icon-button sidebar-nav-active" data-target="post-toc-wrap" title="æ–‡ç« ç›®éŒ„"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-list-ordered"></use></svg></li><li class="sidebar-nav-item sidebar-nav-overview hty-icon-button" data-target="site-overview-wrap" title="ç¶²ç«™æ¦‚è¦½"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-passport-line"></use></svg></li></ul><div class="sidebar-panel" id="site-overview-wrap"><div class="site-info fix-top"><a class="site-author-avatar" href="/about/" title="SubaRya"><img width="96" loading="lazy" src="/img/honoka.webp" alt="SubaRya"></a><div class="site-author-name"><a href="/about/">SubaRya</a></div><a class="site-name" href="/about/site.html">ã‚¹ãƒãƒªãƒ£ãƒãƒ–ãƒ­ã‚°</a><sub class="site-subtitle"></sub><div class="site-desciption"></div></div><nav class="site-state"><a class="site-state-item hty-icon-button icon-home" href="/" title="é¦–é "><span class="site-state-item-icon"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-home-4-line"></use></svg></span></a><div class="site-state-item"><a href="/archives/" title="æ­¸æª”"><span class="site-state-item-icon"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-archive-line"></use></svg></span><span class="site-state-item-count">42</span></a></div><div class="site-state-item"><a href="/categories/" title="åˆ†é¡"><span class="site-state-item-icon"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-folder-2-line"></use></svg></span><span class="site-state-item-count">10</span></a></div><div class="site-state-item"><a href="/tags/" title="æ¨™ç±¤"><span class="site-state-item-icon"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-price-tag-3-line"></use></svg></span><span class="site-state-item-count">91</span></a></div><a class="site-state-item hty-icon-button" target="_blank" rel="noopener" href="https://yun.yunyoujun.cn/" title="Hexo-Theme-Yun"><span class="site-state-item-icon"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-settings-line"></use></svg></span></a></nav><hr style="margin-bottom:0.5rem"><div class="links-of-author"><a class="links-of-author-item hty-icon-button" rel="noopener" href="https://github.com/KutsunaSubaRya" title="GitHub" target="_blank" style="color:#6e5494"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-github-line"></use></svg></a><a class="links-of-author-item hty-icon-button" rel="noopener" href="https://twitter.com/Kutsuna_SubaRya" title="Twitter" target="_blank" style="color:#1da1f2"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-twitter-line"></use></svg></a><a class="links-of-author-item hty-icon-button" rel="noopener" href="https://t.me/Kutsuna_SubaRya" title="Telegram" target="_blank" style="color:#0088CC"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-telegram-line"></use></svg></a><a class="links-of-author-item hty-icon-button" rel="noopener" href="index20010928@gmail.com" title="E-Mail" target="_blank" style="color:#8E71C1"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-mail-line"></use></svg></a><a class="links-of-author-item hty-icon-button" rel="noopener" href="https://www.facebook.com/srya3906/" title="Facebook" target="_blank" style="color:#1da1f2"><i class="ion-logo-facebook"></i></a></div><hr style="margin:0.5rem 1rem"><div class="links"><a class="links-item hty-icon-button" href="/links/" title="å‹æƒ…é€£çµ" style="color:dodgerblue"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-open-arm-line"></use></svg></a></div><br><a class="links-item hty-icon-button" id="toggle-mode-btn" href="javascript:;" title="Mode" style="color: #f1cb64"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-contrast-2-line"></use></svg></a></div><div class="sidebar-panel sidebar-panel-active" id="post-toc-wrap"><div class="post-toc"><div class="post-toc-content"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%9B%AE%E5%89%8D%E5%B0%88%E6%A1%88%E8%88%87-remote-server-%E7%9A%84%E6%83%85%E5%A2%83"><span class="toc-number">1.</span> <span class="toc-text">ç›®å‰å°ˆæ¡ˆèˆ‡ remote server çš„æƒ…å¢ƒ</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Pipeline-%E7%B5%90%E6%A7%8B"><span class="toc-number">2.</span> <span class="toc-text">Pipeline çµæ§‹</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%9A%8E%E6%AE%B5%E7%B4%B0%E7%AF%80"><span class="toc-number">3.</span> <span class="toc-text">éšæ®µç´°ç¯€</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-dependencies"><span class="toc-number">3.1.</span> <span class="toc-text">1. dependencies</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-lint"><span class="toc-number">3.2.</span> <span class="toc-text">2. lint</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-build-develop%EF%BC%88%E5%83%85%E9%99%90-develop-%E5%88%86%E6%94%AF%EF%BC%89"><span class="toc-number">3.3.</span> <span class="toc-text">3. build_developï¼ˆåƒ…é™ develop åˆ†æ”¯ï¼‰</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-deploy-develop%EF%BC%88%E5%83%85%E9%99%90-develop-%E5%88%86%E6%94%AF%EF%BC%89"><span class="toc-number">3.4.</span> <span class="toc-text">4. deploy_developï¼ˆåƒ…é™ develop åˆ†æ”¯ï¼‰</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%83%A8%E7%BD%B2%E7%92%B0%E5%A2%83%E5%89%8D%E7%BD%AE%E6%AD%A5%E9%A9%9F"><span class="toc-number">3.4.1.</span> <span class="toc-text">éƒ¨ç½²ç’°å¢ƒå‰ç½®æ­¥é©Ÿ</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#SSH-%E9%80%A3%E7%B7%9A%E6%B8%AC%E8%A9%A6"><span class="toc-number">3.4.2.</span> <span class="toc-text">SSH é€£ç·šæ¸¬è©¦</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%83%A8%E7%BD%B2%E6%AD%A5%E9%A9%9F"><span class="toc-number">3.4.3.</span> <span class="toc-text">éƒ¨ç½²æ­¥é©Ÿ</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8%E5%88%B0%E7%9A%84-GitLab-CI-%E8%AE%8A%E6%95%B8"><span class="toc-number">4.</span> <span class="toc-text">ä½¿ç”¨åˆ°çš„ GitLab CI è®Šæ•¸</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%B8%80%E4%BA%9B-Cloudflare-Zero-Trust-Access-%E5%B0%8F%E7%A7%91%E6%99%AE"><span class="toc-number">5.</span> <span class="toc-text">ä¸€äº› Cloudflare Zero Trust Access å°ç§‘æ™®</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%82%BA%E4%BB%80%E9%BA%BC-SSH-%E5%92%8C-SCP-%E9%9C%80%E8%A6%81-CF-ACCESS-CLIENT-ID-%E5%92%8C-CF-ACCESS-CLIENT-SECRET%EF%BC%9F"><span class="toc-number">5.1.</span> <span class="toc-text">ç‚ºä»€éº¼ SSH å’Œ SCP éœ€è¦ CF_ACCESS_CLIENT_ID å’Œ CF_ACCESS_CLIENT_SECRETï¼Ÿ</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1-Cloudflare-Zero-Trust-%E7%9A%84%E8%BA%AB%E4%BB%BD%E9%A9%97%E8%AD%89%E6%A9%9F%E5%88%B6"><span class="toc-number">5.1.1.</span> <span class="toc-text">1. Cloudflare Zero Trust çš„èº«ä»½é©—è­‰æ©Ÿåˆ¶</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-%E5%8F%96%E4%BB%A3%E5%82%B3%E7%B5%B1-SSH-%E9%91%B0%E5%8C%99%E7%9A%84%E7%9F%AD%E6%9A%AB%E6%86%91%E8%AD%89"><span class="toc-number">5.1.2.</span> <span class="toc-text">2. å–ä»£å‚³çµ± SSH é‘°åŒ™çš„çŸ­æš«æ†‘è­‰</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-%E6%94%AF%E6%8F%B4%E8%87%AA%E5%8B%95%E5%8C%96%E7%B3%BB%E7%B5%B1"><span class="toc-number">5.1.3.</span> <span class="toc-text">3. æ”¯æ´è‡ªå‹•åŒ–ç³»çµ±</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Cloudflare-Application-%E8%88%87-Policy-%E7%9A%84%E9%97%9C%E4%BF%82"><span class="toc-number">5.2.</span> <span class="toc-text">Cloudflare Application èˆ‡ Policy çš„é—œä¿‚</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1-Cloudflare-Application"><span class="toc-number">5.2.1.</span> <span class="toc-text">1. Cloudflare Application</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-Cloudflare-Policy"><span class="toc-number">5.2.2.</span> <span class="toc-text">2. Cloudflare Policy</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8%E8%88%87%E6%B5%81%E7%A8%8B%E6%88%AA%E5%9C%96"><span class="toc-number">6.</span> <span class="toc-text">ä½¿ç”¨èˆ‡æµç¨‹æˆªåœ–</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%BB%BA%E7%AB%8B-Token"><span class="toc-number">6.1.</span> <span class="toc-text">å»ºç«‹ Token</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%BB%BA%E7%AB%8B-Policy"><span class="toc-number">6.2.</span> <span class="toc-text">å»ºç«‹ Policy</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%BB%BA%E7%AB%8B-Application"><span class="toc-number">6.3.</span> <span class="toc-text">å»ºç«‹ Application</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%B5%90%E6%9D%9F%E5%B7%A5%E4%BD%9C"><span class="toc-number">6.4.</span> <span class="toc-text">çµæŸå·¥ä½œ</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%BE%8C%E7%BA%8C%E6%AD%A4-CI-x2F-CD-%E6%9C%89%E5%BE%85%E6%93%B4%E5%85%85"><span class="toc-number">7.</span> <span class="toc-text">å¾ŒçºŒæ­¤ CI&#x2F;CD æœ‰å¾…æ“´å……</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%99%84%E4%B8%8A%E6%88%91-Develop-%E7%89%88%E6%9C%AC%E7%9A%84-gitlab-ci-yml"><span class="toc-number">8.</span> <span class="toc-text">é™„ä¸Šæˆ‘ Develop ç‰ˆæœ¬çš„ gitlab-ci.yml</span></a></li></ol></div></div></div></aside><main class="sidebar-translate" id="content"><div id="post"><article class="hty-card post-block" itemscope itemtype="https://schema.org/Article"><link itemprop="mainEntityOfPage" href="https://blog.subarya.me/2025/04/12/%5B2025%20GitLab%20CI%20CD%5D%E5%89%8D%E7%AB%AFCI-CD%E8%B8%A9%E5%9D%91%E5%BF%83%E5%BE%97/"><span hidden itemprop="author" itemscope itemtype="https://schema.org/Person"><meta itemprop="name" content="SubaRya"><meta itemprop="description"></span><span hidden itemprop="publisher" itemscope itemtype="https://schema.org/Organization"><meta itemprop="name" content="ã‚¹ãƒãƒªãƒ£ãƒãƒ–ãƒ­ã‚°"></span><header class="post-header"><h1 class="post-title" itemprop="name headline">å‰ç«¯ CI-CD è¸©å‘èˆ‡ Cloudflare Zero Trust Access ä½¿ç”¨å¿ƒå¾—</h1><div class="post-meta"><div class="post-time" style="display:inline-block"><span class="post-meta-item-icon"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-calendar-line"></use></svg></span> <time title="å‰µå»ºæ™‚é–“ï¼š2025-04-12 20:00:00" itemprop="dateCreated datePublished" datetime="2025-04-12T20:00:00+00:00">2025-04-12</time></div><div class="post-classify"><span class="post-category"> <span class="post-meta-item-icon" style="margin-right:3px;"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-folder-line"></use></svg></span><span itemprop="about" itemscope itemtype="https://schema.org/Thing"><a class="category" href="/categories/%E5%BF%83%E5%BE%97/" style="--text-color:var(--hty-text-color)" itemprop="url" rel="index"><span itemprop="text">å¿ƒå¾—</span></a></span></span><span class="post-tag"><span class="post-meta-divider">-</span><a class="tag" href="/tags/2025/" style="--text-color:var(--hty-text-color)"><span class="post-meta-item-icon"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-price-tag-3-line"></use></svg></span><span class="tag-name">2025</span></a><a class="tag" href="/tags/remote-server/" style="--text-color:var(--hty-text-color)"><span class="post-meta-item-icon"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-price-tag-3-line"></use></svg></span><span class="tag-name">remote_server</span></a><a class="tag" href="/tags/CI-CD/" style="--text-color:var(--hty-text-color)"><span class="post-meta-item-icon"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-price-tag-3-line"></use></svg></span><span class="tag-name">CI/CD</span></a><a class="tag" href="/tags/GitLab/" style="--text-color:var(--hty-text-color)"><span class="post-meta-item-icon"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-price-tag-3-line"></use></svg></span><span class="tag-name">GitLab</span></a><a class="tag" href="/tags/DevOps/" style="--text-color:var(--hty-text-color)"><span class="post-meta-item-icon"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-price-tag-3-line"></use></svg></span><span class="tag-name">DevOps</span></a></span></div></div></header><section class="post-body" itemprop="articleBody"><div class="post-content markdown-body" style="--smc-primary:#0078E7;"><p>å‰è¨€ï¼š</p>
<blockquote>
<p>é€™ç¯‡æ˜¯å°ˆé–€å°æ–¼ GitLab CI&#x2F;CD è€Œå¯«çš„ Writeupï¼Œå¦‚æœæ˜¯ GitHub çš„ï¼Œåƒ…ä¾›åƒè€ƒæ ¸å¿ƒé‚è¼¯å³å¯ã€‚<br>ç­†è€…ç¬¬ä¸€æ¬¡å¯« CI&#x2F;CDï¼Œå¦‚æœ‰èª¤æˆ–æ”¹é€²ä¹‹è™•ï¼Œå¯ä»¥è·Ÿæˆ‘èªª &gt;&lt;</p>
</blockquote>
<hr>
<h2 id="ç›®å‰å°ˆæ¡ˆèˆ‡-remote-server-çš„æƒ…å¢ƒ"><a href="#ç›®å‰å°ˆæ¡ˆèˆ‡-remote-server-çš„æƒ…å¢ƒ" class="headerlink" title="ç›®å‰å°ˆæ¡ˆèˆ‡ remote server çš„æƒ…å¢ƒ"></a>ç›®å‰å°ˆæ¡ˆèˆ‡ remote server çš„æƒ…å¢ƒ</h2><ul>
<li>å°ˆæ¡ˆ<ul>
<li>Nuxt3</li>
</ul>
</li>
<li>Server<ul>
<li>Ubuntu 23.04 x86_64</li>
<li>ä¸»æ©Ÿæ²’æœ‰ç›´æ¥å°å¤–çš„å…¬ç¶² IPï¼Œæ˜¯é€é Cloudflare Tunnel å»ºç«‹ä¸€å€‹å°å¤–å¯è¨ªå•çš„é€šé“</li>
</ul>
</li>
</ul>
<hr>
<h2 id="Pipeline-çµæ§‹"><a href="#Pipeline-çµæ§‹" class="headerlink" title="Pipeline çµæ§‹"></a>Pipeline çµæ§‹</h2><p>Pipeline ä¾åºåˆ†ç‚ºä»¥ä¸‹éšæ®µï¼š</p>
<ol>
<li><strong>dependencies</strong>ï¼šå®‰è£ä¾è³´å¥—ä»¶ã€‚</li>
<li><strong>lint</strong>ï¼šéœæ…‹åˆ†æèˆ‡å‹åˆ¥æª¢æŸ¥ã€‚</li>
<li><strong>build</strong>ï¼šå»ºç½® Nuxt å°ˆæ¡ˆã€‚</li>
<li><strong>deploy</strong>ï¼šéƒ¨ç½²è‡³æŒ‡å®šé–‹ç™¼ç’°å¢ƒ(è‡ªå·±çš„ remote server)ã€‚</li>
</ol>
<hr>
<h2 id="éšæ®µç´°ç¯€"><a href="#éšæ®µç´°ç¯€" class="headerlink" title="éšæ®µç´°ç¯€"></a>éšæ®µç´°ç¯€</h2><h3 id="1-dependencies"><a href="#1-dependencies" class="headerlink" title="1. dependencies"></a>1. dependencies</h3><ul>
<li><strong>ä½œç”¨</strong>ï¼šå®‰è£èˆ‡ç·©å­˜å°ˆæ¡ˆä¾è³´å¥—ä»¶</li>
<li><strong>æŒ‡ä»¤</strong>ï¼š</li>
</ul>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">pnpm</span> <span class="token function">install</span>
<span class="token function">pnpm</span> run prepare<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>
<ul>
<li><strong>Artifacts</strong>ï¼š<code>.nuxt</code></li>
</ul>
<hr>
<h3 id="2-lint"><a href="#2-lint" class="headerlink" title="2. lint"></a>2. lint</h3><ul>
<li><strong>ä½œç”¨</strong>ï¼šç¢ºä¿ç¨‹å¼ç¢¼ç¬¦åˆè¦ç¯„ä¸”ç„¡å‹åˆ¥éŒ¯èª¤</li>
<li><strong>æŒ‡ä»¤</strong>ï¼š</li>
</ul>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">pnpm</span> lint
<span class="token function">pnpm</span> vue-tsc <span class="token parameter variable">--noEmit</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span></span></code></pre>

<hr>
<h3 id="3-build-developï¼ˆåƒ…é™-develop-åˆ†æ”¯ï¼‰"><a href="#3-build-developï¼ˆåƒ…é™-develop-åˆ†æ”¯ï¼‰" class="headerlink" title="3. build_developï¼ˆåƒ…é™ develop åˆ†æ”¯ï¼‰"></a>3. build_developï¼ˆåƒ…é™ develop åˆ†æ”¯ï¼‰</h3><ul>
<li>Environment å¯ä»¥åœ¨ <code>å´é‚Šæ¬„ &gt; Operate &gt; Environments &gt; New environment</code></li>
</ul>
<ul>
<li><strong>ç›®çš„</strong>ï¼šå°‡ Nuxt å°ˆæ¡ˆç·¨è­¯ç‚ºå¯éƒ¨ç½²çš„éœæ…‹æª”æ¡ˆã€‚</li>
<li><strong>æŒ‡ä»¤</strong>ï¼š<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">pnpm</span> build<span aria-hidden="true" class="line-numbers-rows"><span></span></span></code></pre></li>
<li><strong>Artifacts</strong>ï¼š<code>.output/</code></li>
<li><strong>ç’°å¢ƒè¨­å®š</strong>ï¼š<pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">environment</span><span class="token punctuation">:</span>
  <span class="token key atrule">name</span><span class="token punctuation">:</span> develop
<span class="token key atrule">only</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> develop<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span></span></code></pre></li>
</ul>
<hr>
<h3 id="4-deploy-developï¼ˆåƒ…é™-develop-åˆ†æ”¯ï¼‰"><a href="#4-deploy-developï¼ˆåƒ…é™-develop-åˆ†æ”¯ï¼‰" class="headerlink" title="4. deploy_developï¼ˆåƒ…é™ develop åˆ†æ”¯ï¼‰"></a>4. deploy_developï¼ˆåƒ…é™ develop åˆ†æ”¯ï¼‰</h3><ul>
<li><strong>ç›®çš„</strong>ï¼šå°‡å»ºç½®å¥½çš„æª”æ¡ˆé€é Cloudflare Tunnel èˆ‡ SSH Proxy å®‰å…¨éƒ¨ç½²è‡³é–‹ç™¼ä¸»æ©Ÿã€‚</li>
</ul>
<h4 id="éƒ¨ç½²ç’°å¢ƒå‰ç½®æ­¥é©Ÿ"><a href="#éƒ¨ç½²ç’°å¢ƒå‰ç½®æ­¥é©Ÿ" class="headerlink" title="éƒ¨ç½²ç’°å¢ƒå‰ç½®æ­¥é©Ÿ"></a>éƒ¨ç½²ç’°å¢ƒå‰ç½®æ­¥é©Ÿ</h4><ul>
<li>å®‰è£å¿…å‚™å·¥å…·ï¼š<ul>
<li><code>openssh-client</code></li>
<li><code>cloudflared</code></li>
</ul>
</li>
<li>å»ºç«‹ SSH é‡‘é‘°</li>
</ul>
<h4 id="SSH-é€£ç·šæ¸¬è©¦"><a href="#SSH-é€£ç·šæ¸¬è©¦" class="headerlink" title="SSH é€£ç·šæ¸¬è©¦"></a>SSH é€£ç·šæ¸¬è©¦</h4><p>é€é Cloudflare Tunnel å»ºç«‹ SSH Proxy ä¸¦æ¸¬è©¦é€£ç·šï¼š</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">ssh</span> <span class="token parameter variable">-o</span> <span class="token string">"ProxyCommand=/usr/local/bin/cloudflared access ssh --hostname <span class="token variable">$DEPLOY_HOST</span> \
--service-token-id <span class="token variable">$CF_ACCESS_CLIENT_ID</span> \
--service-token-secret <span class="token variable">$CF_ACCESS_CLIENT_SECRET</span>"</span> <span class="token punctuation">\</span>
<span class="token parameter variable">-o</span> <span class="token assign-left variable">StrictHostKeyChecking</span><span class="token operator">=</span>no <span class="token punctuation">\</span>
<span class="token variable">$DEPLOY_USER</span>@<span class="token variable">$DEPLOY_HOST</span> <span class="token string">"echo âœ… SSH via Cloudflare Access succeeded"</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<h4 id="éƒ¨ç½²æ­¥é©Ÿ"><a href="#éƒ¨ç½²æ­¥é©Ÿ" class="headerlink" title="éƒ¨ç½²æ­¥é©Ÿ"></a>éƒ¨ç½²æ­¥é©Ÿ</h4><ul>
<li>å°‡ artifacts ä¸Šå‚³è‡³æŒ‡å®šä¼ºæœå™¨ç›®éŒ„ï¼š</li>
</ul>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">scp</span> <span class="token parameter variable">-o</span> <span class="token string">"ProxyCommand=/usr/local/bin/cloudflared access ssh --hostname <span class="token variable">$DEPLOY_HOST</span> \
--service-token-id <span class="token variable">$CF_ACCESS_CLIENT_ID</span> \
--service-token-secret <span class="token variable">$CF_ACCESS_CLIENT_SECRET</span>"</span> <span class="token punctuation">\</span>
<span class="token parameter variable">-o</span> <span class="token assign-left variable">StrictHostKeyChecking</span><span class="token operator">=</span>no <span class="token punctuation">\</span>
<span class="token parameter variable">-r</span> .output/* <span class="token variable">$DEPLOY_USER</span>@<span class="token variable">$DEPLOY_HOST</span>:/var/www/nuxt-develop/<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<ul>
<li>ç™»å…¥é ç«¯ä¸»æ©Ÿä¸¦åŸ·è¡Œéƒ¨ç½²è…³æœ¬ï¼š</li>
</ul>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token function">ssh</span> <span class="token parameter variable">-o</span> <span class="token string">"ProxyCommand=/usr/local/bin/cloudflared access ssh --hostname <span class="token variable">$DEPLOY_HOST</span> \
--service-token-id <span class="token variable">$CF_ACCESS_CLIENT_ID</span> \
--service-token-secret <span class="token variable">$CF_ACCESS_CLIENT_SECRET</span>"</span> <span class="token punctuation">\</span>
<span class="token parameter variable">-o</span> <span class="token assign-left variable">StrictHostKeyChecking</span><span class="token operator">=</span>no <span class="token punctuation">\</span>
<span class="token variable">$DEPLOY_USER</span>@<span class="token variable">$DEPLOY_HOST</span> <span class="token string">"bash -c <span class="token entity" title="\&quot;">\"</span>
  cd /var/www/nuxt-develop &amp;&amp;
  pm2 delete nuxt-develop || true &amp;&amp;
  pm2 start ecosystem.config.js &amp;&amp;
  pm2 save<span class="token entity" title="\&quot;">\"</span>"</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre>

<hr>
<h2 id="ä½¿ç”¨åˆ°çš„-GitLab-CI-è®Šæ•¸"><a href="#ä½¿ç”¨åˆ°çš„-GitLab-CI-è®Šæ•¸" class="headerlink" title="ä½¿ç”¨åˆ°çš„ GitLab CI è®Šæ•¸"></a>ä½¿ç”¨åˆ°çš„ GitLab CI è®Šæ•¸</h2><ul>
<li>ç¢ºä¿ä»¥ä¸‹è®Šæ•¸å·²å®‰å…¨å„²å­˜åœ¨ GitLab CI ä¸­ï¼š<ul>
<li><code>å´é‚Šæ¬„ &gt; Settings &gt; CI/CD &gt; Variables</code></li>
</ul>
</li>
<li>è¨­å®š Variable æ™‚è¨˜å¾—é–‹å•Ÿ Mask &amp; Protected</li>
</ul>
<table>
<thead>
<tr>
<th>è®Šæ•¸åç¨±</th>
<th>èªªæ˜</th>
<th>ç¯„ä¾‹</th>
</tr>
</thead>
<tbody><tr>
<td><code>DEPLOY_HOST</code></td>
<td>éƒ¨ç½²ä¼ºæœå™¨åŸŸå</td>
<td><code>example.com</code></td>
</tr>
<tr>
<td><code>DEPLOY_USER</code></td>
<td>éƒ¨ç½²ä¼ºæœå™¨ç™»å…¥ä½¿ç”¨è€…</td>
<td><code>serverusername</code></td>
</tr>
<tr>
<td><code>CF_ACCESS_CLIENT_ID</code></td>
<td>Cloudflare Access çš„æœå‹™ Token ID</td>
<td><code>12345678.access</code></td>
</tr>
<tr>
<td><code>CF_ACCESS_CLIENT_SECRET</code></td>
<td>Cloudflare Access çš„æœå‹™å¯†é‘°</td>
<td><code>abcdef1234567890</code></td>
</tr>
<tr>
<td><code>SSH_PRIVATE_KEY</code></td>
<td>SSH ç§é‘°</td>
<td>å„²å­˜åœ¨ GitLab Secure å…§</td>
</tr>
</tbody></table>
<hr>
<h2 id="ä¸€äº›-Cloudflare-Zero-Trust-Access-å°ç§‘æ™®"><a href="#ä¸€äº›-Cloudflare-Zero-Trust-Access-å°ç§‘æ™®" class="headerlink" title="ä¸€äº› Cloudflare Zero Trust Access å°ç§‘æ™®"></a>ä¸€äº› Cloudflare Zero Trust Access å°ç§‘æ™®</h2><h3 id="ç‚ºä»€éº¼-SSH-å’Œ-SCP-éœ€è¦-CF-ACCESS-CLIENT-ID-å’Œ-CF-ACCESS-CLIENT-SECRETï¼Ÿ"><a href="#ç‚ºä»€éº¼-SSH-å’Œ-SCP-éœ€è¦-CF-ACCESS-CLIENT-ID-å’Œ-CF-ACCESS-CLIENT-SECRETï¼Ÿ" class="headerlink" title="ç‚ºä»€éº¼ SSH å’Œ SCP éœ€è¦ CF_ACCESS_CLIENT_ID å’Œ CF_ACCESS_CLIENT_SECRETï¼Ÿ"></a>ç‚ºä»€éº¼ SSH å’Œ SCP éœ€è¦ CF_ACCESS_CLIENT_ID å’Œ CF_ACCESS_CLIENT_SECRETï¼Ÿ</h3><h4 id="1-Cloudflare-Zero-Trust-çš„èº«ä»½é©—è­‰æ©Ÿåˆ¶"><a href="#1-Cloudflare-Zero-Trust-çš„èº«ä»½é©—è­‰æ©Ÿåˆ¶" class="headerlink" title="1. Cloudflare Zero Trust çš„èº«ä»½é©—è­‰æ©Ÿåˆ¶"></a>1. <strong>Cloudflare Zero Trust çš„èº«ä»½é©—è­‰æ©Ÿåˆ¶</strong></h4><p>æˆ‘çš„ <code>.gitlab-ci.yml</code> ä¸­ï¼Œ<code>ssh</code> å’Œ <code>scp</code> å‘½ä»¤ä½¿ç”¨äº† <code>cloudflared</code> ä½œç‚ºä»£ç†ï¼ˆ<code>ProxyCommand</code>ï¼‰ï¼ŒCloudflare æä¾›æ­¤å·¥å…·ä»¥å»ºç«‹èˆ‡ Cloudflare ç¶²è·¯çš„å®‰å…¨é€£ç·šã€‚</p>
<p>ç‚ºäº†ç¢ºä¿ã€Œåªæœ‰æˆæ¬Šçš„ç”¨æˆ¶æˆ–ç³»çµ±ã€å¯ä»¥å­˜å–æˆ‘çš„ serverï¼ŒCloudflare Zero Trust è¦æ±‚é€²è¡Œèº«ä»½é©—è­‰ã€‚</p>
<p>é€™æ™‚å¾Œå°±éœ€è¦ <code>CF_ACCESS_CLIENT_ID</code> å’Œ <code>CF_ACCESS_CLIENT_SECRET</code> é€™ä¸€å° Service Tokenï¼Œç”¨ä¾†å…è¨±æˆ‘çš„ CI&#x2F;CD æµæ°´ç·šä»¥ç¨‹å¼åŒ–çš„æ–¹å¼å­˜å–å—ä¿è­·çš„è³‡æºï¼Œè€Œä¸éœ€è¦æ‰‹å‹•ç™»éŒ„èº«ä»½æä¾›è€…ï¼ˆIdentity Provider, IdPï¼‰ã€‚</p>
<p>å¦‚æœæ²’æœ‰é€™å° Service Tokenï¼Œå°±æœƒåœ¨ job åŸ·è¡Œä¸­çœ‹åˆ°ä»¥ä¸‹é€™å€‹ã€Œè¦ä½ é»é€£çµä»¥ç™»å…¥ã€çš„äº’å‹•å¼ç™»å…¥æ–¹æ³•ï¼Œé€™æ˜é¡¯èˆ‡æˆ‘å€‘è‡ªå‹•åŒ–èƒŒé“è€Œé¦³ã€‚</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash">Please <span class="token function">open</span> the following URL and log <span class="token keyword">in</span> with your Cloudflare account:
https://aaa/cdn-cgi/access/cli?aud<span class="token operator">=</span>xxx<span class="token operator">&amp;</span><span class="token assign-left variable">edge_token_transfer</span><span class="token operator">=</span>true<span class="token operator">&amp;</span><span class="token assign-left variable">redirect_url</span><span class="token operator">=</span>yyy<span class="token operator">&amp;</span><span class="token assign-left variable">send_org_token</span><span class="token operator">=</span>true<span class="token operator">&amp;</span><span class="token assign-left variable">token</span><span class="token operator">=</span>zzz
Leave cloudflared running to download the token automatically.<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>

<p>å…·é«”ä¾†èªªï¼š</p>
<ul>
<li><strong>CF_ACCESS_CLIENT_ID</strong>ï¼šå°±æ˜¯ä¸€å€‹å…¬é–‹çš„è­˜åˆ¥ç¢¼ï¼Œç”¨ä¾†æ¨™è­˜ Service Tokenã€‚</li>
<li><strong>CF_ACCESS_CLIENT_SECRET</strong>ï¼šå°±æ˜¯ä¸€å€‹ç§˜å¯†é‡‘é‘°ï¼Œèˆ‡ <code>Client ID</code> é…å°ï¼Œç”¨ä¾†é©—è­‰è«‹æ±‚çš„åˆæ³•æ€§ã€‚</li>
</ul>
<p>åœ¨æˆ‘çš„è…³æœ¬ä¸­ï¼Œ<code>cloudflared access ssh</code> å‘½ä»¤æœƒä½¿ç”¨é€™å° token ä¾†èˆ‡ Cloudflare é€²è¡Œèº«ä»½é©—è­‰ï¼š</p>
<pre class="line-numbers language-bash" data-language="bash"><code class="language-bash"><span class="token assign-left variable">ProxyCommand</span><span class="token operator">=</span>/usr/local/bin/cloudflared access <span class="token function">ssh</span> <span class="token parameter variable">--hostname</span> <span class="token variable">$DEPLOY_HOST</span> <span class="token punctuation">\</span>
--service-token-id <span class="token variable">$CF_ACCESS_CLIENT_ID</span> <span class="token punctuation">\</span>
--service-token-secret <span class="token variable">$CF_ACCESS_CLIENT_SECRET</span><span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span></span></code></pre>
<p>ç•¶ <code>cloudflared</code> åŸ·è¡Œæ™‚ï¼Œå®ƒæœƒå°‡é€™å° Token ç™¼é€åˆ° Cloudflareï¼ŒCloudflare æœƒé©—è­‰ token çš„æœ‰æ•ˆæ€§ã€‚å¦‚æœé©—è­‰é€šéï¼ŒCloudflare æœƒç”Ÿæˆä¸€å€‹è‡¨æ™‚çš„ JSON Web Tokenï¼ˆJWTï¼‰ï¼Œå…è¨±æˆ‘çš„ <code>ssh</code> æˆ– <code>scp</code> å‘½ä»¤é€šé Cloudflare çš„ç¶²è·¯é€£æ¥åˆ°ç›®æ¨™ä¼ºæœå™¨ã€‚</p>
<h4 id="2-å–ä»£å‚³çµ±-SSH-é‘°åŒ™çš„çŸ­æš«æ†‘è­‰"><a href="#2-å–ä»£å‚³çµ±-SSH-é‘°åŒ™çš„çŸ­æš«æ†‘è­‰" class="headerlink" title="2. å–ä»£å‚³çµ± SSH é‘°åŒ™çš„çŸ­æš«æ†‘è­‰"></a>2. <strong>å–ä»£å‚³çµ± SSH é‘°åŒ™çš„çŸ­æš«æ†‘è­‰</strong></h4><p>å‚³çµ±çš„ SSH é€£ç·šé€šå¸¸ä¾è³´é•·æœŸå­˜åœ¨çš„ SSH é‘°åŒ™ï¼ˆä¾‹å¦‚ <code>~/.ssh/id_rsa</code>ï¼‰ã€‚ç„¶è€Œï¼ŒCloudflare Zero Trust å¼•å…¥äº†ä¸€å€‹æ›´å®‰å…¨çš„æ©Ÿåˆ¶ï¼šä½¿ç”¨çŸ­æš«çš„ SSH æ†‘è­‰ï¼ˆshort-lived certificatesï¼‰ã€‚é€™äº›æ†‘è­‰æ˜¯ç”± Cloudflare çš„æ†‘è­‰æ©Ÿæ§‹ï¼ˆCAï¼‰ç°½ç™¼çš„ï¼Œä¸¦ä¸”æœ‰æ•ˆæœŸå¾ˆçŸ­ï¼ˆé€šå¸¸å¹¾å°æ™‚ï¼‰ï¼Œå¾è€Œé™ä½äº†é•·æœŸæ†‘è­‰è¢«ç›œç”¨çš„é¢¨éšªã€‚</p>
<p>åœ¨æˆ‘çš„éƒ¨ç½²æµç¨‹ä¸­ï¼Œ<code>CF_ACCESS_CLIENT_ID</code> å’Œ <code>CF_ACCESS_CLIENT_SECRET</code> è¢«ç”¨ä¾†å‘ Cloudflare è«‹æ±‚é€™äº›çŸ­æš«æ†‘è­‰ã€‚Cloudflare æœƒæ ¹æ“šæˆ‘çš„èº«ä»½ï¼ˆç”± Service Token é©—è­‰ï¼‰å’Œå­˜å–ç­–ç•¥ï¼ˆAccess Policyï¼‰ä¾†æ±ºå®šæ˜¯å¦ç°½ç™¼æ†‘è­‰ã€‚å¦‚æœç­–ç•¥å…è¨±ï¼ŒCloudflare æœƒç°½ç™¼ä¸€å€‹çŸ­æš«æ†‘è­‰ï¼Œ<code>cloudflared</code> æœƒä½¿ç”¨é€™å€‹æ†‘è­‰ä¾†å®Œæˆèˆ‡ä¼ºæœå™¨çš„ SSH é€£ç·šã€‚</p>
<p>é€™ç¨®æ–¹æ³•çš„å¥½è™•æ˜¯ï¼š</p>
<ul>
<li><strong>ç„¡éœ€ç®¡ç†é•·æœŸ SSH é‘°åŒ™</strong>ï¼šæˆ‘ä¸éœ€è¦åœ¨ä¼ºæœå™¨ä¸Šç¶­è­·å¤šå€‹ç”¨æˆ¶çš„å…¬é‘°ã€‚</li>
<li><strong>æ›´é«˜çš„å®‰å…¨æ€§</strong>ï¼šçŸ­æš«æ†‘è­‰éæœŸå¾Œå°±ç„¡æ•ˆï¼Œå³ä½¿è¢«ç›œç”¨ï¼Œå½±éŸ¿ç¯„åœä¹Ÿæœ‰é™ã€‚</li>
</ul>
<h4 id="3-æ”¯æ´è‡ªå‹•åŒ–ç³»çµ±"><a href="#3-æ”¯æ´è‡ªå‹•åŒ–ç³»çµ±" class="headerlink" title="3. æ”¯æ´è‡ªå‹•åŒ–ç³»çµ±"></a>3. <strong>æ”¯æ´è‡ªå‹•åŒ–ç³»çµ±</strong></h4><p>æˆ‘çš„ GitLab CI&#x2F;CD æµæ°´ç·šæ˜¯ä¸€å€‹è‡ªå‹•åŒ–ç³»çµ±ï¼Œç„¡æ³•åƒäººé¡ç”¨æˆ¶ä¸€æ¨£é€šéç€è¦½å™¨ç™»éŒ„èº«ä»½æä¾›è€…ï¼ˆä¾‹å¦‚ Google æˆ– Oktaï¼‰ä¾†é€²è¡Œèº«ä»½é©—è­‰ã€‚<code>CF_ACCESS_CLIENT_ID</code> å’Œ <code>CF_ACCESS_CLIENT_SECRET</code> æä¾›äº†ä¸€ç¨®ç¨‹å¼åŒ–çš„èº«ä»½é©—è­‰æ–¹å¼ï¼Œå…è¨±æˆ‘çš„æµæ°´ç·šä»¥ã€Œæœå‹™èº«ä»½ã€ï¼ˆService Authï¼‰çš„æ–¹å¼å­˜å–å—ä¿è­·çš„è³‡æºã€‚</p>
<p>å¦‚æœæˆ‘æ²’æœ‰ä½¿ç”¨ Service Tokenï¼ŒCloudflare æœƒè¦æ±‚æˆ‘çš„æµæ°´ç·šé€šéèº«ä»½æä¾›è€…é€²è¡Œäº’å‹•å¼ç™»éŒ„ï¼Œé€™åœ¨ CI&#x2F;CD ç’°å¢ƒä¸­æ˜¯ä¸åˆ‡å¯¦éš›çš„ã€‚å› æ­¤ï¼ŒService Token æ˜¯è‡ªå‹•åŒ–éƒ¨ç½²çš„é—œéµã€‚</p>
<p>é€™è£¡å‘¼æ‡‰ä¸Šé¢ç¬¬ä¸€é»èªªçš„ï¼š</p>
<blockquote>
<p>é€™å€‹ã€Œè¦ä½ é»é€£çµä»¥ç™»å…¥ã€çš„äº’å‹•å¼ç™»å…¥æ–¹æ³•ï¼Œé€™æ˜é¡¯èˆ‡æˆ‘å€‘è‡ªå‹•åŒ–èƒŒé“è€Œé¦³ã€‚</p>
</blockquote>
<h3 id="Cloudflare-Application-èˆ‡-Policy-çš„é—œä¿‚"><a href="#Cloudflare-Application-èˆ‡-Policy-çš„é—œä¿‚" class="headerlink" title="Cloudflare Application èˆ‡ Policy çš„é—œä¿‚"></a>Cloudflare Application èˆ‡ Policy çš„é—œä¿‚</h3><p><img src="/img/gitlabcicd-1.png" alt="alt text" loading="lazy"></p>
<p>ä¸Šåœ–æ˜¯ Cloudflare Zero Trust çš„å´é‚Šæ¬„</p>
<h4 id="1-Cloudflare-Application"><a href="#1-Cloudflare-Application" class="headerlink" title="1. Cloudflare Application"></a>1. <strong>Cloudflare Application</strong></h4><ul>
<li><p><strong>Cloudflare Application</strong></p>
<ul>
<li>åœ¨ Cloudflare Zero Trust ä¸­ï¼Œ<code>Application</code> æ˜¯ä¸€å€‹å—ä¿è­·çš„è³‡æºï¼ˆä¾‹å¦‚æˆ‘çš„ SSH Serverï¼‰ã€‚</li>
</ul>
</li>
<li><p><strong>Application Config</strong>ï¼š</p>
<ul>
<li>é€™è£¡éœ€è¦æŒ‡å®šç›®æ¨™ä¼ºæœå™¨çš„ä¸»æ©Ÿå (ä¾‹å¦‚ <code>xxx.subarya.me</code>)</li>
</ul>
</li>
<li><p><strong>Service Token èˆ‡ Application çš„é—œä¿‚</strong>ï¼š</p>
<ul>
<li>åœ¨ New Application æ™‚ï¼Œé€šå¸¸æœƒé…ç½®å­˜å–ç­–ç•¥ï¼ˆAccess Policyï¼‰ï¼ŒæŒ‡å®šå“ªäº›ç”¨æˆ¶æˆ–æœå‹™å¯ä»¥å­˜å–é€™å€‹æ‡‰ç”¨ã€‚</li>
<li>æˆ‘çš„ Service Tokenï¼ˆ<code>CF_ACCESS_CLIENT_ID</code> å’Œ <code>CF_ACCESS_CLIENT_SECRET</code>ï¼‰æ˜¯èˆ‡é€™å€‹ Application ç¶å®šçš„ã€‚ç•¶ <code>cloudflared</code> ä½¿ç”¨é€™å° Token é€²è¡Œèº«ä»½é©—è­‰æ™‚ï¼ŒCloudflare æœƒæª¢æŸ¥è©² Token æ˜¯å¦è¢«æˆæ¬Šå­˜å–é€™å€‹ç‰¹å®šçš„æ‡‰ç”¨ã€‚</li>
<li>å¦‚æœ Token æœ‰æ•ˆï¼ŒCloudflare æœƒç”Ÿæˆä¸€å€‹ JWTï¼Œå…è¨±æˆ‘çš„æµæ°´ç·šå­˜å–æ‡‰ç”¨ï¼ˆå³æˆ‘çš„ SSH ä¼ºæœå™¨ï¼‰ã€‚</li>
</ul>
</li>
</ul>
<h4 id="2-Cloudflare-Policy"><a href="#2-Cloudflare-Policy" class="headerlink" title="2. Cloudflare Policy"></a>2. <strong>Cloudflare Policy</strong></h4><p>Cloudflare Zero Trust çš„å­˜å–ç­–ç•¥ï¼ˆAccess Policyï¼‰å®šç¾©äº†èª°ï¼ˆæˆ–ä»€éº¼ï¼‰å¯ä»¥å­˜å–æˆ‘çš„æ‡‰ç”¨ï¼Œä»¥åŠåœ¨ä»€éº¼æ¢ä»¶ä¸‹å¯ä»¥å­˜å–ã€‚</p>
<ul>
<li><p><strong>Policy Config</strong>ï¼š</p>
<ul>
<li>åœ¨ Cloudflare Zero Trust å„€è¡¨æ¿ä¸­ï¼Œæˆ‘å¯ä»¥ç‚ºæˆ‘çš„ Application å‰µå»ºä¸€å€‹ Policyï¼Œä¾‹å¦‚ï¼š<ul>
<li><strong>å‹•ä½œï¼ˆActionï¼‰</strong>ï¼šè¨­ç‚º <code>Service Auth</code>ï¼Œè¡¨ç¤ºå…è¨±ä½¿ç”¨ Service Token (é‚£ä¸€å° Client ID å’Œ Secret) é€²è¡Œèº«ä»½é©—è­‰ã€‚</li>
<li><strong>æ¢ä»¶ï¼ˆConditionsï¼‰</strong>ï¼šæŒ‡å®šå…è¨±çš„ Service Tokenï¼ˆä¾‹å¦‚æˆ‘çš„ <code>CF_ACCESS_CLIENT_ID</code>ï¼‰ã€‚</li>
<li><strong>å…¶ä»–æ¢ä»¶</strong>ï¼šæˆ‘å¯ä»¥æ·»åŠ é¡å¤–çš„æ¢ä»¶ï¼Œä¾‹å¦‚é™åˆ¶å­˜å–çš„ IP ç¯„åœã€è¨­å‚™å§¿æ…‹ï¼ˆDevice Postureï¼‰ç­‰ã€‚</li>
</ul>
</li>
<li>ä¾‹å¦‚ï¼Œæˆ‘å¯ä»¥é…ç½®ä¸€å€‹ Policyï¼Œåªå…è¨±ç‰¹å®šçš„ Service Token å­˜å–æˆ‘çš„ä¼ºæœå™¨ï¼Œè€Œå…¶ä»–æœªæˆæ¬Šçš„ Token æˆ–ç”¨æˆ¶æœƒè¢«æ‹’çµ•ã€‚</li>
</ul>
</li>
<li><p><strong>Policy åŸ·è¡Œ</strong>ï¼š</p>
<ul>
<li>ç•¶æˆ‘çš„æµæ°´ç·šä½¿ç”¨ <code>CF_ACCESS_CLIENT_ID</code> å’Œ <code>CF_ACCESS_CLIENT_SECRET</code> é€²è¡Œèº«ä»½é©—è­‰æ™‚ï¼ŒCloudflare æœƒæª¢æŸ¥é€™äº› Token ã€Œæ˜¯å¦ç¬¦åˆ Application çš„ Access Policyã€ã€‚</li>
<li>å¦‚æœç¬¦åˆï¼ŒCloudflare æœƒå…è¨±é€£ç·šï¼Œä¸¦ç°½ç™¼çŸ­æš«æ†‘è­‰çµ¦ <code>cloudflared</code>ï¼Œç”¨æ–¼èˆ‡ä¼ºæœå™¨å»ºç«‹ SSH é€£ç·šã€‚</li>
<li>å¦‚æœä¸ç¬¦åˆï¼ˆä¾‹å¦‚ Token å·²éæœŸæˆ–è¢«æ’¤éŠ·ï¼‰ï¼ŒCloudflare æœƒæ‹’çµ•é€£ç·šï¼Œä¸¦è¨˜éŒ„ä¸€å€‹ã€Œå­˜å–è¢«æ‹’ã€ï¼ˆAccess Deniedï¼‰äº‹ä»¶ã€‚</li>
</ul>
</li>
</ul>
<hr>
<h2 id="ä½¿ç”¨èˆ‡æµç¨‹æˆªåœ–"><a href="#ä½¿ç”¨èˆ‡æµç¨‹æˆªåœ–" class="headerlink" title="ä½¿ç”¨èˆ‡æµç¨‹æˆªåœ–"></a>ä½¿ç”¨èˆ‡æµç¨‹æˆªåœ–</h2><h3 id="å»ºç«‹-Token"><a href="#å»ºç«‹-Token" class="headerlink" title="å»ºç«‹ Token"></a>å»ºç«‹ Token</h3><ol>
<li>é€²å…¥ Cloudflare Zero Trust Access çš„ æœå‹™é©—è­‰</li>
<li>é»é¸ã€Œå»ºç«‹æœå‹™ Tokenã€</li>
</ol>
<p><img src="/img/gitlabcicd-4.png" alt="alt text" loading="lazy"></p>
<ol start="3">
<li>å¡«å¯«å®Œåç¨±å’ŒæŒçºŒæ™‚é–“</li>
</ol>
<p><img src="/img/gitlabcicd-5.png" alt="alt text" loading="lazy"></p>
<ol start="4">
<li>ç¬¬ä¸‰é»ä½œå®Œå¾Œé»ã€Œç”¢ç”Ÿ Tokenã€ä¸¦ã€Œè‡ªå·±å­˜å¥½ç”¨æˆ¶ç«¯ ID å’Œ å¯†ç¢¼ã€å¾Œå¦‚ä¸‹åœ–</li>
</ol>
<p><img src="/img/gitlabcicd-6.png" alt="alt text" loading="lazy"></p>
<h3 id="å»ºç«‹-Policy"><a href="#å»ºç«‹-Policy" class="headerlink" title="å»ºç«‹ Policy"></a>å»ºç«‹ Policy</h3><ol>
<li>é€²å…¥ Cloudflare Zero Trust Access çš„ åŸå‰‡</li>
<li>é»é¸ã€Œæ–°å¢åŸå‰‡ã€</li>
</ol>
<p><img src="/img/gitlabcicd-7.png" alt="alt text" loading="lazy"></p>
<ol start="3">
<li>è¼¸å…¥èˆ‡é¸æ“‡ï¼š<ol>
<li>å¡«å¯«åŸå‰‡åç¨±</li>
<li>å‹•ä½œé¸ Service Auth</li>
<li>ä¸‹é¢æ–°å¢è¦å‰‡è™•çš„ã€Œé¸å–å™¨ã€é¸æ“‡ã€ŒService Tokenã€</li>
<li>å€¼ é¸æ“‡ ä¸Šé¢å»ºç«‹ Token æ™‚å–çš„åç¨±</li>
<li>ç¢ºèªæ–°å¢è¦å‰‡è™• 3, 4 é»éƒ½æ˜¯ä½¿ç”¨ã€ŒåŒ…å« ORã€</li>
<li>å³ä¸‹è§’å„²å­˜</li>
</ol>
</li>
</ol>
<p><img src="/img/gitlabcicd-8.png" alt="alt text" loading="lazy"></p>
<ol start="4">
<li>å¦‚æœä½ çš„ Server æœ¬èº«é€²å…¥æ–¹æ³•å°±æ˜¯ç”¨ Tunnel å†çœ‹ä»¥ä¸‹çš„è§£é‡‹<ul>
<li>ä½ æœƒç™¼ç¾è¦å‰‡å»ºç«‹å¾Œï¼Œå¦‚æœå…ˆå»æŠŠ Application ä¸²èµ·ä¾†ï¼Œä½ æœƒç™¼ç¾ä½ åœ¨æœ¬åœ°ç«¯ ssh é€² remote server æ™‚è¢«æ“‹åœ¨å¤–é¢äº†</li>
<li>åŸå› æ˜¯ä½ åœ¨åŸæœ¬è‡ªå·±çš„è£ç½®ä¸Šæ‡‰è©²åœ¨ <code>~/.ssh/config</code> ä¸­æœ‰è¨­å®šéâ€¦</li>
<li><img src="/img/gitlabcicd-9.png" alt="alt text" loading="lazy"></li>
<li>æ­å–œã€ä½ æ²’æœ‰é‚£ä¸€å° Service Token</li>
<li>å› æ­¤ä½ éœ€è¦å†å»ºç«‹ä¸€å€‹ Policyï¼Œé€™æ¬¡å‹•ä½œé¸ Allow (ä¸æ˜¯ Service Auth)</li>
<li>é¸å–å™¨æˆ‘æ˜¯é¸ Emailï¼Œç„¶å¾Œå¡«å…¥ä½ çš„ Email å³å¯ (é¸ä»€éº¼çœ‹ä½ æœ¬åœ°ç«¯çš„éœ€æ±‚æ˜¯ä»€éº¼)</li>
<li><img src="/img/gitlabcicd-10.png" alt="alt text" loading="lazy"></li>
<li>å„²å­˜å¾Œä½ å°±æœƒå¾—åˆ°ä¸‹åœ–â€¦</li>
</ul>
</li>
</ol>
<p><img src="/img/gitlabcicd-11.png" alt="alt text" loading="lazy"></p>
<h3 id="å»ºç«‹-Application"><a href="#å»ºç«‹-Application" class="headerlink" title="å»ºç«‹ Application"></a>å»ºç«‹ Application</h3><ol>
<li>é€²å…¥ Cloudflare Zero Trust Access çš„ æ‡‰ç”¨ç¨‹å¼</li>
</ol>
<p><img src="/img/gitlabcicd-2.png" alt="alt text" loading="lazy"></p>
<ol start="2">
<li>é»é¸ <code>åŠ å…¥æ‡‰ç”¨ç¨‹å¼ &gt; è‡ªæˆ‘è£è¼‰çš„é¸å–</code></li>
</ol>
<p><img src="/img/gitlabcicd-3.png" alt="alt text" loading="lazy"></p>
<ol start="3">
<li>å¡«å®Œåç¨±èˆ‡æŒçºŒæ™‚é–“å¾Œ</li>
<li>é»é¸ã€Œæ–°å¢å…¬ç”¨ä¸»æ©Ÿåç¨±ã€ï¼Œç„¶å¾Œå¡«å¯«ç¶²åŸŸå’Œå­ç¶²åŸŸ (é€™è£¡çœ‹ä½ è¦åŠ å…¥çš„æ˜¯ä»€éº¼ï¼Œæˆ‘æ˜¯å…¬ç”¨ä¸»æ©Ÿï¼Œé€™è£¡åè€Œè¦å»çœ‹ä½ åŸæœ¬ Tunnel æˆ–æ˜¯å…¶ä»–æ˜¯æ€éº¼è¨­å®šçš„)</li>
<li>é»é¸ä¸‹é¢ Access åŸå‰‡ çš„ã€Œé¸å–ç¾æœ‰è¦å‰‡ã€</li>
</ol>
<p><img src="/img/gitlabcicd-12.png" alt="alt text" loading="lazy"></p>
<ol start="6">
<li>é¸æ“‡å‰›æ‰å»ºç«‹çš„é‚£å…©æ¢ Policy</li>
</ol>
<p><img src="/img/gitlabcicd-13.png" alt="alt text" loading="lazy"></p>
<ol start="7">
<li>ä¸€ç›´å³ä¸‹è§’ä¸‹ä¸€æ­¥åˆ°å„²å­˜</li>
</ol>
<p><img src="/img/gitlabcicd-14.png" alt="alt text" loading="lazy"></p>
<h3 id="çµæŸå·¥ä½œ"><a href="#çµæŸå·¥ä½œ" class="headerlink" title="çµæŸå·¥ä½œ"></a>çµæŸå·¥ä½œ</h3><p>æ­å–œä½ å®Œæˆã€Œå»ºç«‹ Service Tokenã€ã€ã€Œå»ºç«‹ Policyã€ã€ã€Œå»ºç«‹ Applicationã€å•¦ï¼</p>
<p>æ¥è‘—æŠŠ Service Token æ”¾å…¥ä½ çš„ GitLab CI&#x2F;CD Variables è£¡å§</p>
<hr>
<h2 id="å¾ŒçºŒæ­¤-CI-x2F-CD-æœ‰å¾…æ“´å……"><a href="#å¾ŒçºŒæ­¤-CI-x2F-CD-æœ‰å¾…æ“´å……" class="headerlink" title="å¾ŒçºŒæ­¤ CI&#x2F;CD æœ‰å¾…æ“´å……"></a>å¾ŒçºŒæ­¤ CI&#x2F;CD æœ‰å¾…æ“´å……</h2><ul>
<li>å»ºç«‹å…¶ä»–åˆ†æ”¯æµç¨‹ï¼ˆå¦‚ <code>staging</code>, <code>production</code>ï¼‰</li>
<li>å°å…¥æ¸¬è©¦ï¼ˆå¦‚æ•´åˆæ¸¬è©¦ã€E2E æ¸¬è©¦ï¼‰</li>
</ul>
<hr>
<h2 id="é™„ä¸Šæˆ‘-Develop-ç‰ˆæœ¬çš„-gitlab-ci-yml"><a href="#é™„ä¸Šæˆ‘-Develop-ç‰ˆæœ¬çš„-gitlab-ci-yml" class="headerlink" title="é™„ä¸Šæˆ‘ Develop ç‰ˆæœ¬çš„ gitlab-ci.yml"></a>é™„ä¸Šæˆ‘ Develop ç‰ˆæœ¬çš„ gitlab-ci.yml</h2><pre class="line-numbers language-yaml" data-language="yaml"><code class="language-yaml"><span class="token key atrule">stages</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> dependencies
  <span class="token punctuation">-</span> lint
  <span class="token punctuation">-</span> build
  <span class="token punctuation">-</span> deploy

<span class="token key atrule">image</span><span class="token punctuation">:</span> node<span class="token punctuation">:</span><span class="token number">22</span>

<span class="token key atrule">variables</span><span class="token punctuation">:</span>
  <span class="token key atrule">USER_NAME</span><span class="token punctuation">:</span> ntnu_tow
  <span class="token key atrule">REPOSITORY_NAME</span><span class="token punctuation">:</span> nuxt<span class="token punctuation">-</span>3<span class="token punctuation">-</span>ntnutow<span class="token punctuation">-</span>dev

<span class="token key atrule">before_script</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> npm install <span class="token punctuation">-</span><span class="token punctuation">-</span>location=global pnpm@9.15.0
  <span class="token punctuation">-</span> pnpm config set store<span class="token punctuation">-</span>dir .pnpm<span class="token punctuation">-</span>store

<span class="token key atrule">default</span><span class="token punctuation">:</span>
  <span class="token key atrule">cache</span><span class="token punctuation">:</span> <span class="token important">&amp;cache</span>
    <span class="token key atrule">key</span><span class="token punctuation">:</span>
      <span class="token key atrule">files</span><span class="token punctuation">:</span>
        <span class="token punctuation">-</span> pnpm<span class="token punctuation">-</span>lock.yaml
    <span class="token key atrule">paths</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> .pnpm<span class="token punctuation">-</span>store
      <span class="token punctuation">-</span> ./node_modules
    <span class="token key atrule">policy</span><span class="token punctuation">:</span> pull

<span class="token key atrule">install dependencies</span><span class="token punctuation">:</span>
  <span class="token key atrule">stage</span><span class="token punctuation">:</span> dependencies
  <span class="token key atrule">interruptible</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
  <span class="token key atrule">when</span><span class="token punctuation">:</span> always
  <span class="token key atrule">cache</span><span class="token punctuation">:</span>
    <span class="token key atrule">&lt;&lt;</span><span class="token punctuation">:</span> <span class="token important">*cache</span>
    <span class="token key atrule">policy</span><span class="token punctuation">:</span> push
  <span class="token key atrule">script</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> pnpm install
    <span class="token punctuation">-</span> pnpm run prepare
  <span class="token key atrule">artifacts</span><span class="token punctuation">:</span>
    <span class="token key atrule">paths</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> .nuxt
    <span class="token key atrule">expire_in</span><span class="token punctuation">:</span> 1 hour

<span class="token comment"># Lint job ä½¿ç”¨ node image</span>
<span class="token key atrule">lint</span><span class="token punctuation">:</span>
  <span class="token key atrule">stage</span><span class="token punctuation">:</span> lint
  <span class="token key atrule">interruptible</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
  <span class="token key atrule">script</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> echo "ğŸ“ Skipping tests (not implemented yet)"
    <span class="token punctuation">-</span> echo "ğŸ” Running lint<span class="token punctuation">...</span>"
    <span class="token punctuation">-</span> pnpm lint
    <span class="token punctuation">-</span> echo "ğŸ” Running TypeScript type check<span class="token punctuation">...</span>"
    <span class="token punctuation">-</span> pnpm vue<span class="token punctuation">-</span>tsc <span class="token punctuation">-</span><span class="token punctuation">-</span>noEmit

<span class="token key atrule">build_develop</span><span class="token punctuation">:</span>
  <span class="token key atrule">stage</span><span class="token punctuation">:</span> build
  <span class="token key atrule">image</span><span class="token punctuation">:</span> node<span class="token punctuation">:</span><span class="token number">22</span>
  <span class="token key atrule">interruptible</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
  <span class="token key atrule">cache</span><span class="token punctuation">:</span>
    <span class="token key atrule">&lt;&lt;</span><span class="token punctuation">:</span> <span class="token important">*cache</span>
    <span class="token key atrule">policy</span><span class="token punctuation">:</span> pull
  <span class="token key atrule">dependencies</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> install dependencies
  <span class="token key atrule">script</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> echo "ğŸ—ï¸ Building Nuxt 3 project<span class="token punctuation">...</span>"
    <span class="token punctuation">-</span> pnpm build
  <span class="token key atrule">artifacts</span><span class="token punctuation">:</span>
    <span class="token key atrule">paths</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> .output/
    <span class="token key atrule">expire_in</span><span class="token punctuation">:</span> 1 hour
  <span class="token key atrule">environment</span><span class="token punctuation">:</span>
    <span class="token key atrule">name</span><span class="token punctuation">:</span> develop
  <span class="token key atrule">only</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> develop

<span class="token key atrule">deploy_develop</span><span class="token punctuation">:</span>
  <span class="token key atrule">stage</span><span class="token punctuation">:</span> deploy
  <span class="token key atrule">image</span><span class="token punctuation">:</span> alpine<span class="token punctuation">:</span>latest
  <span class="token key atrule">dependencies</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> build_develop
  <span class="token key atrule">before_script</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> apk add <span class="token punctuation">-</span><span class="token punctuation">-</span>no<span class="token punctuation">-</span>cache openssh<span class="token punctuation">-</span>client bash curl
    <span class="token punctuation">-</span> command <span class="token punctuation">-</span>v ssh<span class="token punctuation">-</span>agent <span class="token punctuation">></span>/dev/null <span class="token punctuation">|</span><span class="token punctuation">|</span> ( apk add <span class="token punctuation">-</span><span class="token punctuation">-</span>update openssh )
    <span class="token punctuation">-</span> curl <span class="token punctuation">-</span>L https<span class="token punctuation">:</span>//github.com/cloudflare/cloudflared/releases/latest/download/cloudflared<span class="token punctuation">-</span>linux<span class="token punctuation">-</span>amd64 <span class="token punctuation">-</span>o /usr/local/bin/cloudflared
    <span class="token punctuation">-</span> chmod +x /usr/local/bin/cloudflared
    <span class="token punctuation">-</span> cloudflared <span class="token punctuation">-</span><span class="token punctuation">-</span>version
    <span class="token punctuation">-</span> mkdir <span class="token punctuation">-</span>p ~/.ssh
    <span class="token punctuation">-</span> chmod 700 ~/.ssh
    <span class="token punctuation">-</span> echo "$SSH_PRIVATE_KEY" <span class="token punctuation">|</span> tr <span class="token punctuation">-</span>d '\r' <span class="token punctuation">></span> ~/.ssh/id_rsa
    <span class="token punctuation">-</span> chmod 600 ~/.ssh/id_rsa
    <span class="token punctuation">-</span> eval "$(ssh<span class="token punctuation">-</span>agent <span class="token punctuation">-</span>s)"
    <span class="token punctuation">-</span> ssh<span class="token punctuation">-</span>add ~/.ssh/id_rsa
    <span class="token punctuation">-</span> <span class="token punctuation">|</span><span class="token scalar string">
      ssh -o "ProxyCommand=/usr/local/bin/cloudflared access ssh --hostname $DEPLOY_HOST \
      --service-token-id $CF_ACCESS_CLIENT_ID \
      --service-token-secret $CF_ACCESS_CLIENT_SECRET" \
      -o StrictHostKeyChecking=no \
      $DEPLOY_USER@$DEPLOY_HOST "echo âœ… SSH via Cloudflare Access succeeded"</span>
  <span class="token key atrule">script</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> echo "ğŸš€ Deploying to ta.subarya.me (develop)<span class="token punctuation">...</span>"
    <span class="token punctuation">-</span> <span class="token punctuation">|</span><span class="token scalar string">
      scp -o "ProxyCommand=/usr/local/bin/cloudflared access ssh --hostname $DEPLOY_HOST \
      --service-token-id $CF_ACCESS_CLIENT_ID \
      --service-token-secret $CF_ACCESS_CLIENT_SECRET" \
      -o StrictHostKeyChecking=no \
      -r .output/* $DEPLOY_USER@$DEPLOY_HOST:/var/www/nuxt-develop/</span>
    <span class="token punctuation">-</span> <span class="token punctuation">|</span><span class="token scalar string">
      ssh -o "ProxyCommand=/usr/local/bin/cloudflared access ssh --hostname $DEPLOY_HOST \
      --service-token-id $CF_ACCESS_CLIENT_ID \
      --service-token-secret $CF_ACCESS_CLIENT_SECRET" \
      -o StrictHostKeyChecking=no \
      $DEPLOY_USER@$DEPLOY_HOST "bash -c \"
        cd /var/www/nuxt-develop &amp;&amp;
        pm2 delete nuxt-develop || true &amp;&amp;
        pm2 start ecosystem.config.js &amp;&amp;
        pm2 save\""</span>
  <span class="token key atrule">environment</span><span class="token punctuation">:</span>
    <span class="token key atrule">name</span><span class="token punctuation">:</span> develop
    <span class="token key atrule">url</span><span class="token punctuation">:</span> $ENV_URL
  <span class="token key atrule">only</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> develop<span aria-hidden="true" class="line-numbers-rows"><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span><span></span></span></code></pre></div><ul class="post-copyright"><li class="post-copyright-author"><strong>æœ¬æ–‡ä½œè€…ï¼š</strong>SubaRya</li><li class="post-copyright-link"><strong>æœ¬æ–‡é€£çµï¼š</strong><a href="https://blog.subarya.me/2025/04/12/[2025%20GitLab%20CI%20CD]%E5%89%8D%E7%AB%AFCI-CD%E8%B8%A9%E5%9D%91%E5%BF%83%E5%BE%97/" title="å‰ç«¯ CI-CD è¸©å‘èˆ‡ Cloudflare Zero Trust Access ä½¿ç”¨å¿ƒå¾—">https://blog.subarya.me/2025/04/12/[2025%20GitLab%20CI%20CD]%E5%89%8D%E7%AB%AFCI-CD%E8%B8%A9%E5%9D%91%E5%BF%83%E5%BE%97/</a></li><li class="post-copyright-license"><strong>ç‰ˆæ¬Šè²æ˜ï¼š</strong>æœ¬Blogæ‰€æœ‰æ–‡ç« é™¤äº†ç‰¹åˆ¥è²æ˜å¤–ï¼Œå‡é»˜èªæ¡ç”¨ <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.zh" target="_blank" rel="noopener" title="CC BY-NC-SA 4.0 "><svg class="icon"><use xlink:href="#icon-creative-commons-line"></use></svg><svg class="icon"><use xlink:href="#icon-creative-commons-by-line"></use></svg><svg class="icon"><use xlink:href="#icon-creative-commons-nc-line"></use></svg><svg class="icon"><use xlink:href="#icon-creative-commons-sa-line"></use></svg></a> è¨±å¯ä¹‹å”è­°ã€‚</li></ul></section></article><div class="post-nav"><div class="post-nav-item"></div><div class="post-nav-item"><a class="post-nav-next" href="/2024/11/05/%5BMinecraft%5D%20server%20%E5%92%8C%20client%20%E5%BB%BA%E7%AB%8B%E5%BF%83%E5%BE%97/" rel="next" title="Minecraft - Server And Client Setup (Main RLCraft)"><span class="post-nav-text">Minecraft - Server And Client Setup (Main RLCraft)</span><svg class="icon" aria-hidden="true"><use xlink:href="#icon-arrow-right-s-line"></use></svg></a></div></div></div></main><footer class="sidebar-translate" id="footer"><div class="copyright"><span>&copy; 2019 â€“ 2025 </span><a class="with-love" id="animate" target="_blank" rel="noopener" href="https://sponsors.yunyoujun.cn" title="äº‘æ¸¸å›çš„èµåŠ©è€…ä»¬"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-cloud-line"></use></svg></a><span class="author"> SubaRya</span></div><div class="powered"><span>ç”± <a href="https://hexo.io" target="_blank" rel="noopener">Hexo</a> é©…å‹• v5.4.2</span><span class="footer-separator">|</span><span>ä¸»é¡Œ - <a rel="noopener" href="https://github.com/YunYouJun/hexo-theme-yun" target="_blank"><span>Yun</span></a> v1.5.3</span></div></footer><a class="hty-icon-button" id="goUp" aria-label="back-to-top" href="#"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-arrow-up-s-line"></use></svg><svg class="progress-circle-container" viewBox="0 0 100 100"><circle class="progress-circle" id="progressCircle" cx="50" cy="50" r="48" fill="none" stroke="#0078E7" stroke-width="2" stroke-linecap="round"></circle></svg></a><a class="popup-trigger hty-icon-button icon-search" id="search" target="_blank" rel="noopener" href="https://www.google.com/search?q=site:blog.subarya.me" title="æœå°‹"><span class="site-state-item-icon"><svg class="icon" aria-hidden="true"><use xlink:href="#icon-search-line"></use></svg></span></a></div></body></html>